## Hitmux `hitvid` - 终端视频播放器

[简体中文](https://github.com/Hitmux/hitvid/blob/main/README_zh.md) [English](https://github.com/Hitmux/hitvid/blob/main/README.md)


## [Hitmux 官方网站 https://hitmux.top](https://hitmux.top)

`hitvid` 是一个基于 Bash 脚本的终端视频播放器，它使用 `ffmpeg` 来提取视频帧，并使用 `chafa` 将这些帧渲染为字符艺术，从而实现在终端中播放视频。

-----

## 特性

*   **终端内播放：** 直接在您的终端窗口中观看视频。
*   **交互式播放控制：**
    *   **暂停/恢复：** 使用 `空格键` 切换播放状态。
    *   **快进/快退：** 使用 `右箭头` 和 `左箭头` 键快进或快退 `5` 秒。
    *   **播放速度：** 使用 `上箭头` 和 `下箭头` 键调整播放速度。
*   **多种渲染选项：** 支持自定义 FPS、缩放模式、颜色数量、抖动算法和字符集。
*   **优化帧预处理：** 利用 FFmpeg 根据终端字符尺寸智能预缩放视频帧，减少 Chafa 的工作负载，提高渲染效率。
*   **两种播放模式：**
    *   **`preload` (预加载模式)：** 在开始播放前，提取所有视频帧并将其完全转换为 Chafa 文本帧。此模式初始处理时间较长，但能提供最流畅的播放体验。
    *   **`stream` (流式模式 - 默认)：** 在提取所有视频帧后，它会在后台并行处理 Chafa 文本帧转换，同时开始播放。播放器会等待当前所需帧被渲染完成。此模式允许更快地开始播放，但如果渲染速度跟不上播放速度，可能会出现卡顿。
*   **并行处理：** 利用多核 CPU 并行渲染 Chafa 帧，显著加快预加载模式下的处理速度和流式模式下的帧生成速度。
*   **改进的临时文件处理：** 在可用时优先使用 `tmpfs` (`/dev/shm`) 存储临时文件，通过减少磁盘 I/O 提高性能。
*   **增强的进度反馈：** 在帧提取和渲染过程中提供更清晰的进度条和状态更新。
*   **循环播放：** 支持视频循环播放。
*   **静音模式：** 隐藏进度信息和交互式反馈，仅显示视频内容。
*   **自动清理：** 脚本退出时自动清理生成的临时文件，包括恢复终端设置。

-----

## 依赖项

在运行 `hitvid` 之前，请确保您的系统上已安装以下工具：

*   **`ffmpeg`：** 用于视频解码和帧提取。
*   **`chafa`：** 用于将图像帧转换为终端字符艺术。
*   **`tput`：** 用于终端控制（例如，清屏、隐藏/显示光标、恢复屏幕缓冲区）。
*   **`nproc`：** （可选，推荐）用于获取 CPU 核心数量以优化并行处理线程。如果未安装，默认使用 4 个线程。
*   **`xargs`：** 用于并行执行命令。
*   **`awk`：** 用于浮点数运算。

**安装示例 (Debian/Ubuntu)：**

```bash
sudo apt update
sudo apt install ffmpeg chafa coreutils util-linux
```

(`coreutils` 通常包含 `nproc` 和 `xargs`，`util-linux` 通常包含 `tput`，`awk` 通常是 `gawk` 或 `mawk` 的一部分，并且通常预装在大多数系统上。)

-----

## 用法

```bash
./hitvid.sh [VIDEO_PATH] [OPTIONS]
```

**VIDEO_PATH:**
可以是本地视频文件的路径（例如，`video.mp4`、`/path/to/my/video.avi`），也可以是可直接访问的视频 URL（例如，`http://example.com/video.mp4`）。

-----

## 选项

| 短选项 | 长选项    | 参数      | 描述                                                                    | 默认值                       |
| :----- | :-------- | :-------- | :---------------------------------------------------------------------- | :--------------------------- |
| `-h`   | `--help`  |           | 显示此帮助信息并退出。                                                |                              |
| `-f`   | `--fps`   | `FPS`     | 设置帧提取速率。这也影响播放速度。                                    | `15`                         |
| `-s`   | `--scale` | `MODE`    | 设置 FFmpeg 预缩放和 Chafa 渲染的缩放模式：`fit`（适应）、`fill`（填充）、`stretch`（拉伸）。 | `fit`                        |
| `-c`   | `--colors`| `NUM`     | 设置颜色模式：`2`、`16`、`256`、`full`（全彩）。                        | `256`                        |
| `-d`   | `--dither`| `MODE`    | 设置抖动模式：`none`（无）、`ordered`（有序）、`diffusion`（扩散）。      | `ordered`                    |
| `-y`   | `--symbols`| `SET`    | 设置字符集：`block`（块）、`ascii`（ASCII）、`space`（空格）。          | `block`                      |
| `-w`   | `--width` | `WIDTH`   | 设置显示宽度（以字符为单位）。                                        | 当前终端宽度                 |
| `-t`   | `--height`| `HEIGHT`  | 设置显示高度（以行为单位）。                                          | 当前终端高度 - 2 行            |
| `-m`   | `--mode`  | `MODE`    | 设置播放模式：`preload`（预加载）、`stream`（流式）。                  | `stream`                     |
|        | `--threads`| `N`      | 设置 Chafa 并行渲染的线程数。                                         | 系统 CPU 核心数（或 4 个）   |
| `-q`   | `--quiet` |           | 静音模式，抑制进度和其他信息输出。                                    | 关闭                         |
| `-l`   | `--loop`  |           | 循环播放视频。                                                        | 关闭                         |

**交互式控制（播放期间 - 仅在非 `--quiet` 模式下有效）：**

*   `空格键`：暂停/恢复播放。
*   `右箭头`：快进 `5` 秒。
*   `左箭头`：快退 `5` 秒。
*   `上箭头`：提高播放速度（例如，1.0x -> 1.25x -> 1.5x）。
*   `下箭头`：降低播放速度（例如，1.0x -> 0.75x -> 0.5x）。

-----

## 示例

1.  **基本播放：**

    ```bash
    ./hitvid.sh my_video.mp4
    ```

2.  **以 24 FPS 播放，使用全彩，并填充屏幕：**

    ```bash
    ./hitvid.sh my_video.mp4 --fps 24 --colors full --scale fill
    ```

3.  **使用流式模式并指定 8 个渲染线程（默认是 `stream` 模式和 `nproc` 线程数）：**

    ```bash
    ./hitvid.sh my_video.mp4 --mode stream --threads 8
    ```

4.  **循环播放并使用 ASCII 字符集：**

    ```bash
    ./hitvid.sh animation.gif --loop --symbols ascii
    ```

5.  **静音播放，并自定义宽度和高度：**

    ```bash
    ./hitvid.sh short_clip.mkv --quiet --width 80 --height 24
    ```

在播放这些示例时，您可以使用交互式控制（空格键、方向键）来管理体验。

-----

## 工作流程

`hitvid` 的工作流程因所选播放模式而异：

**1. 共同步骤（所有模式）：**
*   **参数解析与验证：** 读取并验证命令行选项。
*   **依赖项检查：** 确认已安装必要的工具（`ffmpeg`、`chafa`、`tput`、`nproc`、`xargs`、`awk`）。
*   **临时目录设置：** 创建一个临时目录（例如，`/dev/shm/hitvid.XXXXXX` 或 `/tmp/hitvid.XXXXXX`）用于存储中间文件。此目录在脚本退出时会自动清理。
*   **视频信息获取：** 使用 `ffprobe` 获取视频的原始分辨率、时长和其他相关信息。
*   **帧提取（带 FFmpeg 预缩放）：** 使用 `ffmpeg` 以指定的 FPS 将视频提取成一系列 JPG 图像帧。关键在于，`ffmpeg` 会应用一个 `-vf` (视频滤镜) 来预缩放帧到与请求的终端字符尺寸匹配的近似像素分辨率。这大大减轻了 `chafa` 的缩放工作，并有助于保持宽高比和性能。JPG 帧保存在 `jpg_frames` 子目录中。

**2. `preload`（预加载）模式：**
*   **并行 Chafa 帧渲染：**
    *   脚本遍历所有提取的 JPG 图像帧。
    *   它使用 `xargs -P`（并行执行）并发启动多个 `chafa` 进程，将每个 JPG 帧转换为包含 ANSI 转义序列的文本文件。这些文本文件代表在终端中显示的字符艺术。
    *   转换后的文本帧存储在 `chafa_frames` 子目录中。
    *   此步骤会等待所有帧完全渲染完毕后才进入播放阶段，以确保最流畅的播放体验。
*   **播放：**
    *   清屏并隐藏光标。
    *   按顺序从 `chafa_frames` 目录读取预渲染的文本帧文件，并使用 `cat` 命令将其内容输出到终端。`chafa` 的 `--clear` 选项确保每个新帧覆盖前一个帧的区域。
    *   根据设定的 FPS，在帧之间引入一个动态的 `sleep` 延迟，同时考虑实际 `cat` 和显示帧所需的时间。
    *   交互式控制（暂停、快进/快退、速度改变）通过非阻塞的按键读取进行处理。
    *   播放进度显示在专用的一行上。

**3. `stream`（流式）模式（默认）：**
*   **后台并行 Chafa 帧渲染：**
    *   JPG 帧提取完成后，脚本会在**后台**（作为子进程）启动 `render_all_chafa_frames_parallel` 函数。此函数也使用 `xargs -P` 并行渲染 Chafa 文本帧，类似于 `preload` 模式，但它不会阻塞主脚本的执行。
    *   通常会同步预渲染第一帧，以加快启动速度。
*   **播放（同时渲染）：**
    *   清屏并隐藏光标。
    *   当需要播放第 N 帧时：
        *   它首先检查相应的 Chafa 文本帧文件（`chafa_frames/frame-XXXXN.txt`）是否已被后台渲染器生成。
        *   如果文件不存在，播放器会暂停显示并短暂等待，直到后台渲染进程生成该文件。在此等待期间，它还会定期检查后台渲染进程是否意外终止。
        *   一旦帧文件可用，其内容会立即被 `cat` 到终端。
    *   与 `preload` 模式类似，动态的 `sleep` 延迟用于维持所需的 FPS，并处理交互式控制。
    *   播放结束后，如果后台渲染进程仍在运行，主脚本会等待其完成再退出。

**4. 清理：**
*   无论脚本如何退出（正常完成、用户通过 `Ctrl+C` 中断或错误），`trap` 机制都会确保执行 `cleanup` 函数。
*   `cleanup` 函数会恢复终端设置（`stty sane`），使光标可见（`tput cnorm`），恢复正常的屏幕缓冲区（`tput rmcup`），然后安全地删除整个临时目录及其内容。如果后台渲染进程仍在运行，它会尝试终止该进程。

-----

## 注意事项与故障排除

*   **性能：** 尽管 FFmpeg 预缩放和并行 Chafa 渲染显著提高了性能，但播放高分辨率或高码率视频仍然可能面临挑战。最终的显示速度受限于您的 CPU 处理 `chafa`、`ffmpeg` 的能力，以及终端渲染复杂 ANSI 转义序列的速度。使用 `tmpfs` (`/dev/shm`) 存放临时文件有助于缓解磁盘 I/O 瓶颈。
*   **终端兼容性与字体：** 最佳效果在现代终端上实现，这些终端对 ANSI 转义序列（尤其是 256 色或真彩色，以及光标控制）有良好的支持，例如 `gnome-terminal`、`konsole`、`xterm`（正确配置后）、`iTerm2` (macOS) 和 Windows Terminal。等宽字体通常能提供更一致的字符艺术显示。
*   **交互式控制：** 交互式控制通过非等待回车的单字符读取工作。这要求 `hitvid` 临时修改终端设置（`stty`）。`cleanup` 函数会尝试恢复 `stty sane`，但在极少数异常终止情况下（例如，断电），您可能需要在终端中手动运行 `stty sane`。在 `--quiet` 模式下，交互式控制被禁用。
*   **临时文件：** 脚本会生成大量临时文件（JPG 图像帧和 Chafa 文本帧）。请确保您选择的临时目录位置（如果可用，首选 `/dev/shm`，否则 `/tmp`）有足够的可用空间。这些文件在脚本完成或中断时会自动删除。
*   **`--threads` 选项：** `NUM_THREADS` 的最佳值通常是可用的 CPU 核心数。设置过高可能会因过多的上下文切换开销而降低效率。
*   **流式模式卡顿：** 如果您在 `stream` 模式下遇到频繁卡顿，这意味着 Chafa 渲染速度跟不上播放 FPS。您可以尝试：
    *   降低 `--fps` 播放速率。
    *   减少 `--colors`（例如，从 `full` 到 `256`）或 `--symbols`（例如，从 `block` 到 `ascii`）。
    *   增加 `--threads`（如果 CPU 未充分利用）。
    *   切换回 `preload` 模式以获得最流畅的播放体验（但初始等待时间会更长）。
*   **错误：`command not found`：** 确保所有依赖项都已正确安装并存在于您的系统 `PATH` 环境变量中。
*   **FFmpeg 错误：** 如果视频文件损坏，或其格式不被 `ffmpeg` 支持，或者 `ffmpeg` 遇到其他问题，帧提取可能会失败。如果不是静音模式，脚本会尝试显示 `ffmpeg` 的错误日志。
*   **Chafa 错误：** 如果 `chafa` 无法处理图像（例如，由于输入损坏），它可能会生成空帧或报错。脚本目前在 `stream` 模式下会继续播放（显示空帧），但会检查后台渲染器进程是否终止。
